version: 0.2
phases:
  install:
    runtime-versions:
      nodejs: 16
  pre_build:
    commands:
      - export USER=OSML-CodebuildTest
      - export AWS_ACCOUNT=$accountId
      - export DOCKER_BUILDKIT=1
      - cp OversightML/lib/cdk/accounts/target_account_template.json OversightML/lib/cdk/accounts/target_account.json
      - sed -i "s/1234567890123/$AWS_ACCOUNT/" OversightML/lib/cdk/accounts/target_account.json
      - sed -i "s/fake-alias/$USER/" OversightML/lib/cdk/accounts/target_account.json
      - sed -i "s/us-west-1/$AWS_DEFAULT_REGION/" OversightML/lib/cdk/accounts/target_account.json
      - cat OversightML/lib/cdk/accounts/target_account.json
      - curl -O https://bootstrap.pypa.io/get-pip.py
      - python3 get-pip.py --user
      - pip install -r OversightML/lib/integration_test/requirements.txt
      - aws s3 cp s3://oversightml-artifacts-${AWS_ACCOUNT}/images.zip OversightML/assets/images.zip
      - aws s3 cp s3://oversightml-artifacts-${AWS_ACCOUNT}/model_weights.pth OversightML/lib/control_model/assets/model_weights.pth
      - cd OversightML
      - npm install -g aws-cdk
      - npm install
  build:
    commands:
      - npm run build:cdk
      - npm run build:deploy
      - npm run test:integ
